buildscript {

    dependencies {
        classpath 'gradle.plugin.com.ewerk.gradle.plugins:querydsl-plugin:1.0.7'
        classpath 'com.avast.gradle:docker-compose-gradle-plugin:0.3.16'
    }
}

apply plugin: 'com.ewerk.gradle.plugins.querydsl'
apply plugin: 'docker-compose'

dependencies {

    // Required JPA dependencies with hibernate
    compile("org.springframework:spring-orm:${springVersion}")
    compile('org.springframework.data:spring-data-jpa:1.10.2.RELEASE') {
    	exclude group: 'org.springframework', module: 'spring-beans'
    	exclude group: 'org.springframework', module: 'spring-jdbc'
    	exclude group: 'org.springframework', module: 'spring-orm'
    	exclude group: 'org.springframework', module: 'spring-core'
    	exclude group: 'org.springframework', module: 'spring-aop'
    	exclude group: 'org.springframework', module: 'spring-context'
        exclude group: 'commons-logging', module: 'commons-logging'
    }
    compile('org.hibernate:hibernate-entitymanager:5.2.1.Final')


    // Auditory using Hibernate Envers
    compile('org.springframework.data:spring-data-envers:1.0.2.RELEASE')
    compile('org.hibernate:hibernate-envers:5.2.1.Final')


    // Required by spring-context for using JSR-303. See LocalValidatorFactoryBean
    // in rest-config.xml
    compile('javax.validation:validation-api:1.1.0.Final')
    compile('org.hibernate:hibernate-validator:5.2.4.Final')


    // Jackson JSON Processor, required by spring-webmvc. See messageConverters
    // in rest-config.xml
    compile('com.fasterxml.jackson.core:jackson-databind:2.8.1')


    //  Loading data base in run time either using liquibase
    compile('org.liquibase:liquibase-core:3.5.3')
    // or flyway
    compile('org.flywaydb:flyway-core:4.0.3')


    // Jackson Java time support
    compile('com.fasterxml.jackson.datatype:jackson-datatype-jsr310:2.8.1')

    
    // Using Querydsl
    compile('com.querydsl:querydsl-apt:4.1.3')
    compile('com.querydsl:querydsl-jpa:4.1.3')


    // Integration tests
    testCompile("org.springframework:spring-test:${springVersion}") {
        exclude group: 'commons-logging', module: 'commons-logging'
    }

    // Either using H2
    testCompile('com.h2database:h2:1.4.193')
    // or MYSQL with docker :)
    testCompile('mysql:mysql-connector-java:6.0.5')

	// DockerComposeRule DOES NOT WORK FOR THESE REASONS:
	// 1. Spring context is loaded before the DockerComposeRule
	// 2. DockerComposeRule can work with random ports, the problem is:
	// the Spring Context was loaded before DockerComposeRule and dataSource
	// requires some port for connection to data base.

	// These issues can be fixed using org.junit.Suite and running
	// DockerComposeRule in the Suite instead of in every Test.
	// But if I want to run just one test that solution does not work because
	// DockerComposeRule will be declared in the Suite instead of in the Test.
	// We will have to run our tests always from the Suite not being able to run
	// just one Test from the IDE :(
	// See: AdDescriptionRepositoryDockerComposeRuleShould
    testCompile 'com.palantir.docker.compose:docker-compose-rule:0.28.1'
}

querydsl {
  library = 'com.querydsl:querydsl-apt:4.1.3'
  querydslSourcesDir = "$buildDir/generated-sources/querydsl"
  jpa = true
}

integTest.doFirst {
    // It is required in order to run data bases in random ports.
    // We need it for running tests from IDE and from command console but
    // also it will be required by systems like Travis where we do not control
    // the available ports.
    def mysqlInfo = dockerCompose.servicesInfos.mysql
    systemProperty 'DATABASE_PORT', mysqlInfo.ports[3306]
}

dockerCompose.isRequiredBy(integTest)
dockerCompose {
    useComposeFiles = ['src/integTest/resources/docker/docker-compose.yml']
    captureContainersOutput = false
    stopContainers = true
    removeContainers = true
    buildBeforeUp = false
}
